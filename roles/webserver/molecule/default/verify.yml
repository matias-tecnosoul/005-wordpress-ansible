---
- name: Verify
  hosts: all
  become: true
  gather_facts: true
  
  tasks:
    - name: Check if Apache is running
      systemd:
        name: apache2
        state: started
        enabled: yes
      check_mode: true
      register: apache_status
      failed_when: apache_status is changed

    - name: Check if MySQL is running
      systemd:
        name: mysql
        state: started
        enabled: yes
      check_mode: true
      register: mysql_status
      failed_when: mysql_status is changed

    - name: Check PHP version
      command: php --version
      register: php_version_output
      changed_when: false
      failed_when: php_version_output.rc != 0

    - name: Verify PHP 8.x is installed
      assert:
        that:
          - "'PHP 8.' in php_version_output.stdout"
        fail_msg: "PHP 8.x not found. Output: {{ php_version_output.stdout }}"
        success_msg: "PHP 8.x correctly installed: {{ php_version_output.stdout.split()[1] }}"

    - name: Check WordPress directory exists
      stat:
        path: /var/www/html/wordpress
      register: wp_dir
      failed_when: not wp_dir.stat.exists

    - name: Check wp-config.php exists
      stat:
        path: /var/www/html/wordpress/wp-config.php
      register: wp_config
      failed_when: not wp_config.stat.exists

    - name: Test HTTP response
      uri:
        url: "http://localhost"
        method: GET
        status_code: [200, 302, 404]
      register: http_response
      failed_when: http_response.status not in [200, 302, 404]
      retries: 3
      delay: 5

    # Test de DB m√°s espec√≠fico y seguro
    - name: Test database connection with WordPress user
      mysql_query:
        login_host: localhost
        login_user: test_wp_user
        login_password: test_wp_password
        login_db: test_wordpress_db
        query: "SELECT 1 as test_connection"
      register: db_test
      failed_when: db_test is failed

    - name: Verify database query result
      assert:
        that:
          - db_test.query_result[0][0]['test_connection'] == 1
        success_msg: "‚úÖ Database connection working correctly"
        fail_msg: "‚ùå Database query failed"

    - name: Test WordPress can access its database
      mysql_query:
        login_host: localhost
        login_user: test_wp_user
        login_password: test_wp_password
        login_db: test_wordpress_db
        query: "SHOW TABLES"
      register: wp_tables
      failed_when: wp_tables is failed

    - name: Check Apache modules are enabled
      apache2_module:
        name: "{{ item }}"
        state: present
      loop:
        - rewrite
        - headers
      check_mode: true
      register: apache_modules
      failed_when: apache_modules is changed

    - name: Check WordPress configuration contains correct DB info
      lineinfile:
        path: /var/www/html/wordpress/wp-config.php
        line: "define( 'DB_NAME', 'test_wordpress_db' );"
        state: present
      check_mode: true
      register: db_config
      failed_when: db_config is changed

    - name: Check WordPress core files exist
      stat:
        path: "/var/www/html/wordpress/{{ item }}"
      register: wp_core_files
      failed_when: not wp_core_files.stat.exists
      loop:
        - wp-load.php
        - wp-settings.php
        - wp-admin
        - wp-content
        - wp-includes

    - name: Verification summary
      debug:
        msg:
          - "‚úÖ Apache running and configured"
          - "‚úÖ MySQL accessible with WordPress user"  
          - "‚úÖ PHP {{ php_version_output.stdout.split()[1] }} installed"
          - "‚úÖ WordPress files in place"
          - "‚úÖ Database connection working"
          - "‚úÖ HTTP server responding"
          - "‚úÖ wp-config.php correctly configured"
          - "‚úÖ Apache modules enabled"
          - "üöÄ Webserver role verification completed successfully!"
